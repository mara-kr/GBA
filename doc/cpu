############# GPA CPU OVERVIEW ###########
#
# TODO Interrupts, interrupt control
# TODO Thumb vs ARM
#

1) Thumb vs ARM
    Processor has two instruction sets 32-bit ARM & 16-bit THUMB
    THUMB code operates on same register set, faster & smaller code

2) Modes of Operation
    User:       Normal ARM program execution
    FIQ:        Support data transfer/channel process
    IRQ:        General-purpose interrupt handling
    Supervisor: Protected OS mode
    Abort mode: Entered after data/inst. prefetch abort
    System:     Privileged user mode for OS
    Undefined:  Entered when undefined inst executed

3) Registers:
    31x32bit general purpose, 6 status registers
    16x32bit and 1-2 status registers visible at once
    Privileged mode - mode-specific banked registers used (p 31)
                      Also SPSR for each mode
    THUMB: R0-R7 (maps onto ARM R0-R7)
           CPSR/SPSR (maps onto ARM CPSR/SPSR)
           SP (maps onto ARM R13)
           LR (maps onto ARM R14)
           PC (maps onto ARM R15)

    Convention:
        R14: Subroutine link register
        R15: PC
        R16: Current Program State Register (CC flags & mode bits)

    CPSR:
        [31:28] : NZCV
        [27:8]  : reserved
        [7]     : IRQ enable bit
        [6]     : FIQ enable bit
        [5]     : 1=THUMB, 0=ARM state
        [4:0]   : Mode bits (p. 35)
                  10000: User mode          10111: Abort
                  10001: FIQ mode           11011: Undefined
                  10010: IRQ mode           11111: System
                  10011: Supervisor mode

4) Exceptions
    FIQ: Fast interrupt request (unused in GBA)
        Generated by taking nFIQ->0

    IRQ: Interrupt Request
        Generated by taking nIRQ->0, lower priority than FIQ
        Execution jumps to 0x00000018 (which is a branch inst.)

    Abort: Current memory access cannot complete
        Prefetch abort: Occurs during instruction prefetch
                        Prefetched instruction marked as invalid,
                        exception triggered when inst. hits pipeline head
        Data abort:     Occurs during data access
                        Modified base registers written back
                        Swap instruction aborted
                        Block data transfer instructions complete

    SWI: Software interrupt, triggered to request supervisor function
    Undefined instruction: Take undefined instruction trap

    Priority: Reset, Data abort, FIQ, IRQ, Prefetch abort, Undefined inst, SWI

5) ISA
    Conditional Field:
        ARM instructions are conditionally executed based on CPSR CCs
        and instruction's condition field. Iff ZCNV fulfils conditions,
        instructions is executed.

6) Memory Interface
    32-bit addr/data bus

    Cycle Types:    (determine with nMREQ, SEQ)
        Non-sequential cycle: Addr unrelated to previous cycle's address
        Sequential cycle: Addr is same or 1 word/half-word after previous
        Internal cycle: No transfer required (performing internal function,
                        no useful prefetching can be performed at same time)

    Pipelined: Can be off in SRAM/ROM system, On for DRAM.
               On: Address valid in cycle before memory cycle that it refers
                   to.
               Can change during low phase of clock safely

    Data Transfer Size: Can be byte/half-word/word based on MAS[1:0].
                        Word fetched=>A[1:0] undefined
                        MAS shares same timing as addr bus

    In 16-bit mode, data is either on D[31:16] or D[15:0] depending
    on system endianness.

    System can support Virtual memory (ABORT for page faults)
    ARM Swap is uninterruptable (LOCK signal->1 for duration of swap op)


$) Tests
    Memory:
        Address R/W
        Big & Little Endian (BIGEND bit)
        Mem access with abort
        Sequential Reads/Write sets sequential flag
        Word & Half-word transfers
        Transfers in ARM & THUMB mode
        Alignment checks
        Bidirectional BUS signals (nRW, NENOUT)

    ARM/THUMB:
        Switch to THUMB, switching back to ARM

    Mode switching:
        Banked GPR/PC works

    Execptions:
        Undefined instruction
        Data/instruction prefetch abort
        Next address preserved in appropriate link register
        CPSR copied into SPSR
        CPSR mode bits changed
        IRQ handling works (w/ branch at 0x00000018)

    Registers:
        R/W to all ok
        Can't change CPSR I/F bit in user mode

    Reset - works properly

    Instructions (ARM):
        Multiply/Multiply Long, esp. cycle times
        Shift field for second operand
        SWI changes modes properly, correct cycle times

    Instructions (THUMB):

